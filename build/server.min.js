/*! server 2016-02-07 */
function handleRequest(a,b){switch(console.log("handleRequest"),a.url){case"/":console.log("From website"),"GET"==a.method&&(b.writeHead(200,"OK",{"Content-Type":"text/html"}),b.write("<html><head><title>Welcome</title></head><body>"),b.write("<h1>Welcome to Food Tracker History!</h1>"),b.write("<h2>Enter your name to view your food history</h2>"),b.write('<form enctype="application/x-www-form-urlencoded" action="/show" method="post">'),b.write('Name: <input type="text" name="username" /><br />'),b.write('<input type="submit" value="Find my meals!"/>'),b.write("</form></body></html"),b.end());case"/show":if(console.log("Show history"),"POST"==a.method){var c,d="";a.on("data",function(a){d+=a.toString()}),a.on("end",function(){var a=querystring.parse(d);console.log("History for "+a.username),db.all("SELECT * FROM Users WHERE name == (?)",[a.username],function(d,e){if(d)throw d;b.writeHead(200,"OK",{"Content-Type":"text/html"}),b.write("<html><head><title>History</title></head><body>"),b.write("<h1>Here is the history for "+a.username+"</h1>"),db.all("SELECT menu, data FROM Tracker WHERE id == (?)",[e[0].id],function(a,d){c=JSON.stringify(d,null,4),console.log("FROM DB: %s",c);for(var e=0;e<d.length;e++)b.write("<h2>"+d[e].menu+" at time: "+d[e].data+"</h2>");b.end()})})})}break;case"/register":if(console.log("Register new user"),"POST"==a.method){console.log("Received request POST");var e="";a.on("data",function(a){e+=a}),a.on("end",function(){var a=querystring.parse(e);console.log("Name: %s",a.paramUsername);var c;db.each("SELECT id FROM Users WHERE name == 'LAST_ID'",function(d,e){var f=db.prepare("UPDATE Users SET id = (?) WHERE name == 'LAST_ID'");c=e.id+1,console.log("New id is ",c),f.run(c),f.finalize();var g=db.prepare("INSERT INTO Users VALUES (?, ?)");g.run(c,a.paramUsername),g.finalize();var h=c+"";console.log("y=%s, x = %s",h,c),b.end(h)})})}break;case"/new_menu":if(console.log("Add a new menu"),"POST"==a.method){console.log("Received request POST");var e="";a.on("data",function(a){e+=a}),a.on("end",function(){var a=querystring.parse(e),b=a.paramId,c=a.paramFood,d=a.paramTime;console.log("Inset into database for id %s: food = %s, time = %s",b,c,d);var f=db.prepare("INSERT INTO Tracker VALUES (?, ?, ?)");f.run(parseInt(b),c,d),f.finalize()}),b.end("0")}break;case"/history":if(console.log("Retrieve history"),"POST"==a.method){console.log("Received request POST");var e="";a.on("data",function(a){e+=a}),a.on("end",function(){var a=querystring.parse(e),d=a.paramId;db.all("SELECT * FROM Tracker WHERE id == (?)",[parseInt(d)],function(a,d){if(a)throw a;c=JSON.stringify(d),console.log("FROM DB: %s",c),b.end(c)})})}break;default:b.writeHead(404,"Not found",{"Content-Type":"text/html"}),b.end("<html><head><title>404 - Not found</title></head><body><h1>Not found.</h1></body></html>")}}var http=require("http"),querystring=require("querystring"),util=require("util"),fs=require("fs"),file="food_tracker.db",exists=fs.existsSync(file),sqlite3=require("sqlite3").verbose(),db=new sqlite3.Database(file);db.serialize(function(){exists?console.log("Database already created"):(console.log("Create database"),db.run("CREATE TABLE Tracker(id INT, menu TEXT, data TEXT)"),db.run("CREATE TABLE Users(id INT, name TEXT)"),db.run("INSERT INTO Tracker VALUES (1, 'Snitel', '20160204_203424')"),db.run("INSERT INTO Tracker VALUES (1, 'Shaorma', '20160127_162512')"),db.run("INSERT INTO Tracker VALUES (1, 'Burger', '20160205_145043')"),db.run("INSERT INTO Tracker VALUES (1, 'Pizza', '20160206_175032')"),db.run("INSERT INTO Tracker VALUES (1, 'Burger', '20160205_145043')"),db.run("INSERT INTO Users VALUES (1, 'LAST_ID')"),db.run("INSERT INTO Users VALUES (1, 'Irina')"))});const PORT=8080;var server=http.createServer(handleRequest);server.listen(PORT,function(){console.log("Server listening on: http://localhost:%s",PORT)});